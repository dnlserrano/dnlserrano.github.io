<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Movies</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        var movieData = {{ movies | tojson }};

        // i18n translations
        const translations = {
            'en': {
                'title': 'movies on tv',
                'greatMovies': 'great',
                'greatMoviesTooltip': 'Movies rated above 7.5 stars',
                'today': 'today',
                'reset': 'reset'
            },
            'pt': {
                'title': 'filmes na tv',
                'greatMovies': 'melhores',
                'greatMoviesTooltip': 'Filmes com avaliação acima de 7.5 estrelas',
                'today': 'hoje',
                'reset': 'reset'
            }
        };

        // Detect user language
        const userLang = (navigator.language || navigator.userLanguage).split('-')[0];
        const lang = translations[userLang] || translations['en'];
    </script>
    <style>
        /* Mobile-first modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.95);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-content {
            background-color: #1f2937;
            color: white;
            padding: 8px;
            width: 100%;
            font-size: 13px;
            position: relative;
        }

        .modal-content img {
            width: 100%;
            max-width: 140px;
            height: auto;
            margin: 0 auto;
            display: block;
        }

        .modal-content h2 {
            font-size: 1rem;
            line-height: 1.3;
        }

        .modal-content .space-y-2 > * {
            margin-top: 0.4rem;
        }

        .modal-content .space-y-2 > *:first-child {
            margin-top: 0;
        }

        /* Desktop enhancements */
        @media (min-width: 768px) {
            .modal-content {
                margin: 30px auto;
                padding: 20px;
                width: 80%;
                max-width: 700px;
                border-radius: 8px;
                font-size: 15px;
                display: flex;
                gap: 20px;
            }

            .modal-content img {
                max-width: 200px;
                margin: 0;
                flex-shrink: 0;
            }

            .modal-content h2 {
                font-size: 1.4rem;
                line-height: 1.3;
            }

            .modal-content .clear-both {
                display: flex;
                gap: 20px;
                width: 100%;
            }

            .modal-content .text-xs {
                font-size: 0.9rem;
            }
        }

        /* Smooth transitions */
        * {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Mobile-first container -->
    <div class="min-h-screen">
        <!-- Compact header -->
        <header class="sticky top-0 bg-gray-900 z-50 border-b border-gray-800">
            <h1 id="page-title" class="text-lg font-bold py-3 px-3 text-center md:text-2xl md:py-4"></h1>
        </header>

        <!-- Simple filter bar -->
        <div class="bg-gray-800 border-b border-gray-700 px-3 py-2">
            <div class="flex items-center gap-4 flex-wrap">
                <label class="flex items-center gap-2 cursor-pointer" title="">
                    <input type="checkbox" checked id="great-movies-filter" class="w-5 h-5 rounded" onchange="applyFilters()">
                    <span id="great-movies-label" class="text-sm"></span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" checked id="today-filter" class="w-5 h-5 rounded" onchange="applyFilters()">
                    <span id="today-label" class="text-sm"></span>
                </label>
                <button onclick="resetFilters()" id="reset-button" class="ml-auto bg-gray-700 px-3 py-1.5 rounded text-sm font-medium active:bg-gray-600">
                </button>
            </div>
        </div>

        <!-- Movie grid: mobile-first -->
        <div class="grid grid-cols-2 gap-2 p-2 md:grid-cols-4 md:gap-3 md:p-4 lg:grid-cols-6 lg:gap-4" id="movie-grid">
        </div>
    </div>

    <!-- Mobile-optimized modal -->
    <div id="movie-modal" class="modal">
        <div class="modal-content">
            <button class="absolute top-2 right-2 text-2xl leading-none text-gray-400 z-10" onclick="document.getElementById('movie-modal').style.display='none'">&times;</button>

            <div class="clear-both md:clear-none">
                <img id="modal-poster-url" src="" alt="" class="mb-2 md:mb-0" onerror="this.src='/movies/poster.webp'">

                <div class="md:flex-1">
                    <a href="#" id="modal-title-href" target="_blank">
                        <h2 id="modal-title" class="font-bold mb-1 underline md:mb-2"></h2>
                    </a>

                    <p id="modal-original-title" class="text-xs text-gray-400 mb-2 md:text-sm"></p>

                    <div class="space-y-2 text-xs md:space-y-3">
                        <p id="modal-channel" class="text-gray-300"></p>
                        <p id="modal-date" class="text-gray-300"></p>
                        <p id="modal-time" class="text-gray-300"></p>

                        <p class="pt-1 md:pt-2">
                            <span class="font-semibold">Rating:</span>
                            <span id="modal-rating" class="text-yellow-400"></span>
                        </p>

                        <p id="modal-plot" class="pt-2 leading-snug md:pt-3 md:leading-relaxed text-gray-200"></p>

                        <p class="pt-1 md:pt-2">
                            <span class="font-semibold">Director:</span>
                            <span id="modal-director" class="text-gray-300"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
      // Mobile-first: Render movie cards
      function applyFilters() {
        const movieGrid = document.getElementById('movie-grid');
        const now = new Date();

        const isGreatMovies = document.getElementById('great-movies-filter').checked;
        const isTodayMovies = document.getElementById('today-filter').checked;

        const filteredMovies = movieData.filter(movie => {
          const movieDate = new Date(movie.time);
          const meetsGreatMoviesFilter = !isGreatMovies || (parseFloat(movie.rating) > 7.5);
          const meetsTodayFilter = !isTodayMovies || (
            movieDate.getDate() === now.getDate() &&
            movieDate.getMonth() === now.getMonth() &&
            movieDate.getFullYear() === now.getFullYear()
          );
          return meetsGreatMoviesFilter && meetsTodayFilter;
        }).sort((a, b) => new Date(a.time) - new Date(b.time));

        const uniqueMovies = [];
        const seenTitles = new Set();
        filteredMovies.forEach(movie => {
          if (!seenTitles.has(movie.title)) {
            seenTitles.add(movie.title);
            uniqueMovies.push(movie);
          }
        });

        // Mobile-first card rendering
        movieGrid.innerHTML = '';
        uniqueMovies.forEach(movie => {
          const card = document.createElement('div');
          card.className = 'bg-gray-800 rounded overflow-hidden active:opacity-75 transition-opacity';
          card.innerHTML = `
            <div onclick="showMovieDetails('${movie.id}')" class="cursor-pointer">
              <img src="${cleanUrl(movie.poster_url)}" alt="${movie.title}"
                   class="w-full aspect-[2/3] object-cover"
                   onerror="this.src='/movies/poster.webp'">
              <div class="p-2">
                <h3 class="text-xs font-semibold leading-tight line-clamp-2 mb-1 md:text-sm">${movie.title}</h3>
                <p class="text-[10px] text-gray-400 truncate md:text-xs">${movie.channel}</p>
                <p class="text-[10px] text-gray-500 md:text-xs">${movie.time_display}</p>
              </div>
            </div>
          `;
          movieGrid.appendChild(card);
        });
      }

      function resetFilters() {
        document.getElementById('great-movies-filter').checked = true;
        document.getElementById('today-filter').checked = true;
        applyFilters();
      }

      function initializeUI() {
        document.getElementById('page-title').textContent = lang.title;
        document.getElementById('great-movies-label').textContent = lang.greatMovies;
        document.getElementById('great-movies-label').parentElement.title = lang.greatMoviesTooltip;
        document.getElementById('today-label').textContent = lang.today;
        document.getElementById('reset-button').textContent = lang.reset;
        applyFilters();
      }

      function showMovieDetails(movieId) {
        const movie = movieData.find(m => m.id === movieId);
        const modal = document.getElementById("movie-modal");

        document.getElementById("modal-poster-url").src = cleanUrl(movie.poster_url);
        document.getElementById("modal-title").textContent = movie.year && !isNaN(movie.year)
          ? `${movie.title} (${movie.year})`
          : movie.title;
        document.getElementById("modal-title-href").setAttribute("href", `https://imdb.com/title/${movie.id}/`);
        document.getElementById("modal-original-title").textContent = movie.originalTitle || '';
        document.getElementById("modal-channel").textContent = movie.channel || '';
        document.getElementById("modal-date").textContent = movie.date || '';
        document.getElementById("modal-time").textContent = movie.time_display || '';
        document.getElementById("modal-rating").textContent = movie.averageRating || movie.rating || 'N/A';
        document.getElementById("modal-plot").textContent = movie.plot || '';
        document.getElementById("modal-director").textContent = Array.isArray(movie.director)
          ? movie.director.join(', ')
          : (movie.director || 'N/A');

        modal.style.display = "block";
        setTimeout(() => modal.scrollTop = 0, 0); // Reset scroll position

        // Close handlers
        const closeModal = () => {
          modal.style.display = "none";
        };

        document.addEventListener('keydown', function escHandler(e) {
          if (e.key === 'Escape') {
            closeModal();
            document.removeEventListener('keydown', escHandler);
          }
        });

        modal.onclick = function(e) {
          if (e.target === modal) closeModal();
        };
      }

      function cleanUrl(url) {
        if (!url || typeof url !== 'string') return '/movies/poster.webp';

        const imdbPattern = /^(.*)(\._V1_)(.*)(\.[^.]+)$/;
        const match = url.match(imdbPattern);

        if (match) {
          return `${match[1]}._V1_SY400${match[4]}`;
        } else if (url.includes('@@')) {
          const parts = url.split('@@');
          const base = parts[0];
          const extParts = url.split('.');
          const extension = extParts.pop();
          if (base && extension) {
            return `${base}@@._V1_SY400.${extension}`;
          }
        }

        return url === '/movies/poster.webp' ? url : url;
      }

      window.addEventListener('DOMContentLoaded', initializeUI);
    </script>
</body>
</html>
